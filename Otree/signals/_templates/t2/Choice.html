{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}Treatment 2 — Choice (Round {{ player.round_number }} of {{ C.NUM_ROUNDS }}){% endblock %}

{% block content %}
<p>
  In the baseline treatment, you choose <strong>c₁</strong> first. Your prior is
  <strong>50/50</strong> that π = 0.5 or π = 1.5. There is <strong>no feedback</strong>.
</p>

<div class="card mb-3">
  <div class="card-body">
    <ul>
      <li>Current income: <strong>y₁ = {{ y1 }}</strong></li>
      <li>Price now: <strong>p₁ = {{ p1 }}</strong></li>
      <li>Income profile: <strong>x = {{ x }}</strong> (0.5 = decreasing, 1.5 = increasing)</li>
      <li>If π = 1 ⇒ y₂ = <strong>{{ y2_pi1 }}</strong>
    </ul>
  </div>
</div>

<<div class="card mb-3">
  <div class="card-body">
    <p>Choose your period-1 consumption <em>c₁</em>. Feasibility requires <strong>1 ≤ c₁ ≤ {{ c1_max }}</strong>.</p>
    <div style="display: flex; align-items: center; gap: 10px;">
      <span>1</span>
      <input type="range" name="c1" id="c1_slider"
             min="1" max="{{ c1_max }}" step="1"
             value="{{ c1_max }}"
             oninput="c1_out.value=this.value" class="form-range"
             aria-label="a"
      />
      <span>{{ c1_max }}</span>
    </div>
    <div class="mt-2">c₁: <output id="c1_out">{{ c1_max }}</output></div>
  </div>
</div>
<div class="mt-2">
  c₂ if π=0.5: <span id="c2_05">—</span> &nbsp;&nbsp; | &nbsp;&nbsp;
  c₂ if π=1.5: <span id="c2_15">—</span>
</div>
<div class="mt-1 small text-muted">We show “—” if c₂ &lt; 1 (infeasible).</div>

<div class="card mb-3">
  <div class="card-body">
    <p><strong>Utility reference (not feedback):</strong> u(c₁,c₂) = c₁ · c₂</p>
    <p>Utilities for integer c₁ (1–20) under both possible π values. “—” marks infeasible (c₂ &lt; 1).</p>
    <table class="table table-sm table-bordered align-middle">
      <thead>
        <tr>
          <th style="width:10%">c₁</th>
          <th>u at π = 0.5</th>
          <th>u at π = 1.5</th>
        </tr>
      </thead>
      <tbody>
        {% for row in table_rows %}
        <tr>
          <td>{{ row.c1 }}</td>
          <td>{% if row.infeasible05 %}—{% else %}{{ row.u05 }}{% endif %}</td>
          <td>{% if row.infeasible15 %}—{% else %}{{ row.u15 }}{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{{ next_button }}
{% endblock %}

{% block scripts %}
<script>
  // constants from server (defaults from the spec)
  const Y1 = {{ y1 }};
  const P1 = {{ p1 }};
  const R  = {{ R }};
  const X  = {{ x }};
  const C1_MAX = {{ c1_max }};

  const slider = document.getElementById('c1_slider');
  const outC1  = document.getElementById('c1_out');
  const c2_05  = document.getElementById('c2_05');
  const c2_15  = document.getElementById('c2_15');

  function c2_given(c1, pi) {
    // c2 = (pi*x*y1 + R*(y1 - p1*c1)) / (pi*p1)
    const p2 = pi * P1;
    const s  = Y1 - P1 * c1;
    return (pi * X * Y1 + R * s) / p2;
  }

  function fmt(v) {
    return Number.isFinite(v) ? v.toFixed(2) : '—';
  }

  function update() {
    // keep slider within [1, C1_MAX] just in case
    let c1 = Math.min(Math.max(parseFloat(slider.value || 1), 1), C1_MAX);
    outC1.value = c1.toFixed(2);

    const v05 = c2_given(c1, 0.5);
    const v15 = c2_given(c1, 1.5);

    c2_05.textContent = (v05 >= 1) ? fmt(v05) : '—';
    c2_15.textContent = (v15 >= 1) ? fmt(v15) : '—';
  }

  // initial paint + on input
  update();
  slider.addEventListener('input', update);
</script>

{% endblock %}
