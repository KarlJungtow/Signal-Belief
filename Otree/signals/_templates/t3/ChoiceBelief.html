{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}Treatment 3 — Choice (Round {{ player.round_number }} of {{ C.NUM_ROUNDS }}){% endblock %}

{% block content %}
  <p><strong>Belief entry:</strong> What is the likelihood that more than half of the dots were red?</p>
  <div style="display: flex; align-items: center; gap: 10px;">
    <span>0%</span>
    <input type="range" name="belief_input_raw" id="bel_slider" min="0" max="100" step="1"
           value="50" oninput="bel_out.value=this.value" class="form-range" />
    <span>100%</span>
  </div>
  <div>Likelihood: <output id="bel_out">50</output>%</div>

<div class="card mb-3">
  <div class="card-body">
    <ul>
      <li>Current income: <strong>y₁ = {{ y1 }}</strong></li>
      <li>Future income: <strong>y₁ = {{ y2 }}</strong></li>
      <li>Price now: <strong>p₁ = {{ p1 }}</strong></li>
    </ul>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <p>Choose your period-1 consumption <em>c₁</em>. Feasibility requires <strong>1 ≤ c₁ ≤ {{ c1_max }}</strong>.</p>
    <div class="d-flex align-items-center">
      <span class="me-2">1</span>
      <input type="range" name="c1" id="c1_slider"
             min="1" max="{{ c1_max }}" step="1"
             value="{{ c1_max }}"
             oninput="c1_out.value=this.value" class="form-range flex-fill"
             aria-label="a"
      />
      <span class="ms-2">{{ c1_max }}</span>
    </div>
    <div class="mt-2">c₁: <output id="c1_out">{{ c1_max }}</output></div>
  </div>
</div>

<div class="mt-2">
  c₂ if π=0.5: <span id="c2_05">—</span> &nbsp;&nbsp; | &nbsp;&nbsp;
  c₂ if π=1.5: <span id="c2_15">—</span>
</div>
<div class="mt-1 small text-muted">We show “—” if c₂ &lt; 1 (infeasible).</div>

<div class="card mb-3">
  <div class="card-body">
    <p><strong>Utility reference (not feedback):</strong> u(c₁,c₂) = c₁ · c₂</p>
    <p>Utilities for integer c₁ (1–20) under both possible π values. “—” marks infeasible (c₂ &lt; 1).</p>
    <table class="table table-sm table-bordered align-middle">
      <thead>
        <tr>
          <th style="width:10%">c₁</th>
          <th>u at π = 0.5</th>
          <th>u at π = 2</th>
        </tr>
      </thead>
      <tbody>
        {% for row in table_rows %}
        <tr>
          <td>{{ row.c1 }}</td>
          <td>{% if row.infeasible05 %}—{% else %}{{ row.u05 }}{% endif %}</td>
          <td>{% if row.infeasible15 %}—{% else %}{{ row.u15 }}{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{{ next_button }}
{% endblock %}

{% block scripts %}
<script>
  // constants from server (defaults from the spec)
  const Y1 = {{ y1 }};
  const P1 = {{ p1 }};
  const R  = {{ R }};
  const Y2  = {{ y2 }};
  const C1_MAX = {{ c1_max }};

  const slider = document.getElementById('c1_slider');
  const outC1  = document.getElementById('c1_out');
  const c2_05  = document.getElementById('c2_05');
  const c2_15  = document.getElementById('c2_15');

  function c2_given(c1, pi) {
    const p2 = pi * P1;
    const s  = Y1 - P1 * c1;
    return Y2 + (R * s) / p2;
  }

  function fmt(v) {
    return Number.isFinite(v) ? v.toFixed(2) : '—';
  }

  function update() {
    // keep slider within [1, C1_MAX] just in case
    let c1 = Math.min(Math.max(parseFloat(slider.value || 1), 1), C1_MAX);
    outC1.value = c1.toFixed(2);

    const v05 = c2_given(c1, 0.5);
    const v15 = c2_given(c1, 1.5);

    c2_05.textContent = (v05 >= 1) ? fmt(v05) : '—';
    c2_15.textContent = (v15 >= 1) ? fmt(v15) : '—';
  }

  // initial paint + on input
  update();
  slider.addEventListener('input', update);
</script>
{% endblock %}
